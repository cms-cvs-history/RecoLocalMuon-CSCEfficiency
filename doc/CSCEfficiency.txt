###
#
# Stoyan Stoynev, Northwestern University
#
###

==========================================================

                 CSCEfficiency package

========================================================== 

   The CSCefficiencies package is intended to help with calculating
various CSCefficiencies (LCT, strip, wire group, rechit, segment).
It is supposed to be in RecoLocalMuon/CSCEfficiency. There are comments 
within the code. Here is a brief description of the logic in the package.
   
   One of the CSC stations is used as a "reference" station. It is 
required that one (only) segment with 6 hits and chi2/ndf below 3 
is present there. Then another station and ring is searched for a 
signal to calculate efficiencies. This is done
in certain EndCap. Appropriate parameters should be provided in the 
configuration file. For example:

module ana = CSCEfficiency{
    untracked bool writeAsciiFiles = false # obsolete
    untracked string rootFileName = 'monHists.root' # this is the histogram output file
    untracked int32 WorkInEndcap = 1
    untracked int32 ExtrapolateFromStation = 3 # this is the "reference" station
    untracked int32 ExtrapolateToStation = 2 
    untracked int32 ExtrapolateToRing = 2
#   if using existing file to recalculate efficiencies
    untracked bool update = false 

}

   Efficiencies are calculated for all the chambers (or only chosen ones)
in the specified station and ring. To do that the segment from the reference
station is extrapolated to the specified station and ring. Then the 
extrapolation point is checked if it is within the boundaries of a chamber. 
It should be taken into account also that dead zones in the chamber exists.
These are the boundaries of the chamber and the HV region boundaries
(CFEB boundaries could also contribute but usualy the contribution
is small - ~0.1% inefficiency). "Good region" (or just sensitive area)
is defined to be the region within a chamber, that is about ~10 cm
away from boundaries (including HV segments boundaries). This condition
is to be refined but in general the "good region" requirement implies
that the track passes safely within a sensitive area of a chamber.  
   It should be pointed out that there is no information about the 
momentum of the particle (muon) used (not available yet). The iron walls
between stations are ~60 cm thick and thus only muons with energy above
~ 1 GeV could pass. One could check and see that the RMS of the 
difference between the extrapolated point and the real point (segment) 
is ~2 cm if one goes from ME2/2 to ME3/2 (using MIP). The tails in
that distribution are not Gaussian and there are events where big  
differences/deviations could happen. 
  
All the efficiency histograms start with FINAL_.
They are in Chamber_* (for chamber *) and in AllChambers 
(for all the chambers together).

========== EFFICIENCIES =================

1. LCT (ALCT, CLCT, CorrLCT).
  They are calculated in LCT_Efficiencies() function. The extrapolated point
is required to be within a "good region". Then it is checked 
 a) is there a LCT within the chamber or neighboring chambers
 b) is there a LCT within the chamber
 c) is there a LCT within the chamber if "COND = true"*.      

 *If refference station is ME3( ME1) and station to investigate is ME2 
  then in case there is a segment in ME1 (ME3) with direction "close" 
  to the reference segment : "COND = true". This is to say we have segments
  in ME1 and ME3 originating (probably) from 1 track - check ME2 for signal. 

The result is in FINAL_LCTs_Efficiencies (3 sets - a), b), c); each set ALCT,
CLCT, CorrLCT).

Also check FINAL_dydz_Efficienciy_ALCT - this the dependence on dy/dz
(direction of the segment in the refference station).

2. Strip and wiregroup efficiencies.
  They are calculated in StripWire_Efficiencies() function. The extrapolated
point is required to be within a "good region". Then it is checked if
 a) there is a wiregroup in layer x = 1,...,6
 b) there is a strip with more than 13.3 ADC counts above 
    the pedestal) in layer x = 1,...,6

  Events with 0 layers fired are excludedi from efficiency calculations! 
These are events where the muon is out of the chamber (multiple scattering) 
or has died before leaving signal in the chamber.

  The result is in FINAL_WireGroup_Efficiency and  FINAL_Strip_Efficiency.
It is per layer. Strip efficiency should show how big is the effect of
CFEB boundaries (end layers compared to middle ones).

3. RecHit efficiency. 
  It is calculated in RecHitEfficiency() function except c). 
There three different approaches applied. It is instructive to compare 
results from the second and third ones (first one is just for completeness).
  a) The extrapolated point is required to be within a "good region";
then it is checked if there is a rechit in layer x = 1,...,6;
the result is in Final_Rechit_Efficiency; it is per layer.
  b) It is required that ALL the rechits in the chamber to which we
extrapolate are within a "good region"; then it is checked if there 
is a rechit in layer x = 1,...,6; the result is in 
Final_Rechit_Efficiency_good; it is per layer.
There is an additional requirement that there should not be bigger number 
of "missing layers" (no rechits in them) in neighbouring chambers. This is
to avoid dealing with noise rechits (important in MC when no trigger
simulation).
  c) The extrapolated point is required to be within a "good region"; it
is required also that there IS a segment in the chamber under investigation
with "close" direction to the reference one; then it is checked if there is
a rechit in layer x = 1,...,6; the result is in 
Final_Rechit_inSegment_Efficiency; it is per layer.

Events with 0 layers fired are excludedi from efficiency calculations!

In addition to the efficiency plots there are 2D plots of inefficient
events (under conditions in c) ) in every layer. Also there are 1D
plots in local Y without the "good region" requirement (could help 
recognize dead zones; plots in X should be made in strips number or 
angle).

4. Attachment efficiency (rechit to segment).
  It is required that one segment exists in the reference and one 
in the investigated chamber. It is required that there should be one 
rechit in a given layer. Then it is checked if this rechit is in the 
segment. This is insensitive to dead regions. The result is in
FINAL_Attachment_Efficiency () (InefficientSingleHits and AllSingleHits
used for the efficiency calculations). It is per layer.

5. Segment efficiency.
  It is calculated in Segment_Efficiency() function. The extrapolated
point is required to be within a "good region". It is required that
there are at least two layers with rechits in the chamber. It is checked
if a segment exists in the chamber. The result is in FINAL_Segment_Efficiency.
It is per chamber.  

============ COMMENTS ============ 

  The usual usage of the package is to process given set of files with 
one job and to obtain the results. Sometimes one needs to process the files
in multy-job regime. Then the (output) root files can be merged (hadd
sum_all.root job1.root ... jobN.root). To calculate efficiencies using this
file as an input (and output) one needs to set "untracked bool update = true" 
in the configuration file.

  Trigger efficiencies are a separate issue. It is the user responsibility to
pick up appropriate data for the analysis.

  In general LCT efficiencies should show the overall efficiency of
the chamber. Then the other efficiencies deal with specific requirements
needed for the case. They would not give you a clue even if the whole 
chamber is dead (number of events (or errors) would).      

  There are various other useful histograms in the output (not too much)
  inluding histograms used to calculate the efficiency plots.


